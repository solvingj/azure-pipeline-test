variables:
  GOBIN:  "$(GOPATH)/bin" # Go binaries path
  GOPATH: "$(system.defaultWorkingDirectory)/gopath"
  GO111MODULE: "on"
  MODULEPATH: "$(GOPATH)/src/github.com/$(build.repository.name)"
  BIN: $(Build.DefinitionName)
  VER: $(Build.SourceBranchName)
  PLAT: $(System.Phasename)
  BT_API: https://api.bintray.com/content
  BT_REPO: public-generic
  BT_URL: $(BT_API)/$(BT_USER)/$(BT_REPO)/$(BIN)/$(VER)/$(PLAT)
  
trigger:
  branches:
    include: ['*']
  tags:
    include: ['*']
    
jobs:
  - job: windows_x64
    variables: 
      file: $(BIN).exe
    pool:
      vmImage: "vs2017-win2016"
    steps:
      - script: echo %BUILD_SOURCEBRANCHNAME%
        displayName: echo BUILD_SOURCEBRANCHNAME
        condition: startsWith(variables['Build.SourceBranch'], 'refs/tags')
      - script: curl -T $(file) -u$(BT_USER):$(BT_KEY) $(BT_URL)
        displayName: bintray_publish
        condition: succeeded()

  - job: linux_x64
    variables: 
        file: $(BIN)
    pool:
      vmImage: "ubuntu-16.04"
      steps:
        - script: echo %BUILD_SOURCEBRANCHNAME%
          displayName: echo BUILD_SOURCEBRANCHNAME
          condition: startsWith(variables['Build.SourceBranch'], 'refs/tags')
        - script: curl -T $(file) -u$(BT_USER):$(BT_KEY) $(BT_URL)
          displayName: bintray_publish
          condition: succeeded()
      
  - job: macos_x64
    variables: 
      file: $(BIN)
    pool:
      vmImage: "macOS-10.13"
      steps:
        - script: echo %BUILD_SOURCEBRANCHNAME%
          displayName: echo BUILD_SOURCEBRANCHNAME
          condition: startsWith(variables['Build.SourceBranch'], 'refs/tags')
        - script: curl -T $(file) -u$(BT_USER):$(BT_KEY) $(BT_URL)
          displayName: bintray_publish
          condition: succeeded()